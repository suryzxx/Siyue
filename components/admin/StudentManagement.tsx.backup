import React, { useState, useEffect } from 'react';
import { ADMIN_STUDENTS, CAMPUSES } from '../../constants';
import { StudentProfile, StudentStatus, FollowUpStatus } from '../../types';
import SearchableMultiSelect from '../common/SearchableMultiSelect';
import { exportToExcel, ExcelFormatters } from '../../utils/excelExport';

const StudentManagement: React.FC = () => {
  // 筛选状态
  const [filterName, setFilterName] = useState('');
  const [filterAccount, setFilterAccount] = useState('');
  const [filterCampus, setFilterCampus] = useState<string[]>([]);
  const [filterStudentStatus, setFilterStudentStatus] = useState<string[]>([]);
  const [filterFollowUpStatus, setFilterFollowUpStatus] = useState<string[]>([]);

  // 模态框状态
  const [showEditModal, setShowEditModal] = useState(false);
  const [showTransferModal, setShowTransferModal] = useState(false);
  const [showOperationLogModal, setShowOperationLogModal] = useState(false);
  const [showNewStudentModal, setShowNewStudentModal] = useState(false);
  
  // 当前选中的学生
  const [selectedStudent, setSelectedStudent] = useState<StudentProfile | null>(null);
  
  // 编辑表单数据
  const [editFormData, setEditFormData] = useState({
    name: '',
    account: '',
    gender: '男' as '男' | '女',
    birthDate: '',
    studentNumber: '',
    evaluationLevel: '',
    campus: '',
    className: '',
    studentStatus: '在读学生' as StudentStatus,
    followUpStatus: '待跟进' as FollowUpStatus,
  });

  // 转班表单数据
  const [transferFormData, setTransferFormData] = useState({
    currentClass: '',
    targetClass: '',
    transferDate: new Date().toISOString().split('T')[0],
    reason: '',
  });

  // 新生录入表单数据
  const [newStudentFormData, setNewStudentFormData] = useState({
    name: '',
    account: '',
    gender: '男' as '男' | '女',
    birthDate: '',
    studentNumber: '',
    evaluationLevel: '',
    campus: '',
    className: '',
    studentStatus: '潜在学生' as StudentStatus,
    followUpStatus: '待跟进' as FollowUpStatus,
    parentName: '',
    parentPhone: '',
    emergencyContact: '',
    emergencyPhone: '',
  });

  // 操作记录数据
  const [operationLogs, setOperationLogs] = useState<Array<{
    id: number;
    action: string;
    operator: string;
    timestamp: string;
    details: string;
  }>>([]);

  // 学生状态选项
  const studentStatusOptions: StudentStatus[] = ['在读学生', '潜在学生', '历史学生'];
  const followUpStatusOptions: FollowUpStatus[] = ['待跟进', '跟进中', '已邀约', '已签约', '退费&流失'];

  // 筛选逻辑
  const filteredStudents = ADMIN_STUDENTS.filter(student => {
    const matchName = !filterName || student.name.toLowerCase().includes(filterName.toLowerCase());
    const matchAccount = !filterAccount || student.account.includes(filterAccount);
    const matchCampus = filterCampus.length === 0 || (student.campus && filterCampus.includes(student.campus));
    const matchStudentStatus = filterStudentStatus.length === 0 || (student.studentStatus && filterStudentStatus.includes(student.studentStatus));
    const matchFollowUpStatus = filterFollowUpStatus.length === 0 || (student.followUpStatus && filterFollowUpStatus.includes(student.followUpStatus));
    
    return matchName && matchAccount && matchCampus && matchStudentStatus && matchFollowUpStatus;
  });

  // 重置筛选
  const resetFilters = () => {
    setFilterName('');
    setFilterAccount('');
    setFilterCampus([]);
    setFilterStudentStatus([]);
    setFilterFollowUpStatus([]);
  };

  // 导出学生列表
  const exportStudentList = async () => {
    try {
      const columns = [
        { key: 'id', label: '学生ID', width: 12 },
        { key: 'name', label: '姓名', width: 15 },
        { key: 'account', label: '登录账号', width: 15 },
        { key: 'gender', label: '性别', width: 8 },
        { key: 'birthDate', label: '出生年月', width: 12, format: ExcelFormatters.date },
        { key: 'studentNumber', label: '学号', width: 12 },
        { key: 'evaluationLevel', label: '评测等级', width: 10 },
        { key: 'campus', label: '所属校区', width: 15 },
        { key: 'className', label: '所属班级', width: 20 },
        { key: 'studentStatus', label: '学生状态', width: 12, format: ExcelFormatters.status },
        { key: 'followUpStatus', label: '跟进状态', width: 12, format: ExcelFormatters.status },
        { key: 'createdTime', label: '创建时间', width: 18, format: ExcelFormatters.datetime },
        { key: 'updatedTime', label: '更新时间', width: 18, format: ExcelFormatters.datetime },
      ];

      await exportToExcel({
        data: filteredStudents,
        columns,
        sheetName: '学生列表',
        fileName: '学生列表',
        headerStyle: {
          bold: true,
          fillColor: 'FFE8F5E9' // 绿色调
        }
      });
    } catch (error) {
      console.error('导出失败:', error);
      alert('导出失败，请稍后重试');
    }
  };

  // 操作处理函数
  const handleEdit = (student: StudentProfile) => {
    setSelectedStudent(student);
    setEditFormData({
      name: student.name,
      account: student.account,
      gender: student.gender,
      birthDate: student.birthDate || '',
      studentNumber: student.studentNumber || '',
      evaluationLevel: student.evaluationLevel || '',
      campus: student.campus || '',
      className: student.className || '',
      studentStatus: student.studentStatus || '在读学生',
      followUpStatus: student.followUpStatus || '待跟进',
    });
    setShowEditModal(true);
  };

  const handleTransferClass = (student: StudentProfile) => {
    setSelectedStudent(student);
    setTransferFormData({
      currentClass: student.className || '',
      targetClass: '',
      transferDate: new Date().toISOString().split('T')[0],
      reason: '',
    });
    setShowTransferModal(true);
  };

  const handleViewOperationLog = (student: StudentProfile) => {
    setSelectedStudent(student);
    // 模拟操作记录数据
    setOperationLogs([
      { id: 1, action: '创建学生档案', operator: '管理员A', timestamp: '2025-01-15 10:30:00', details: '创建学生基本信息' },
      { id: 2, action: '更新评测等级', operator: '老师B', timestamp: '2025-01-20 14:15:00', details: '评测等级从B+更新为A-' },
      { id: 3, action: '修改校区信息', operator: '管理员A', timestamp: '2025-01-25 09:45:00', details: '校区从龙江校区变更为奥南校区' },
      { id: 4, action: '更新跟进状态', operator: '教务C', timestamp: '2025-01-28 16:20:00', details: '跟进状态从待跟进变更为跟进中' },
    ]);
    setShowOperationLogModal(true);
  };

  const handleGetTempCode = (student: StudentProfile) => {
    const tempCode = Math.random().toString(36).substring(2, 8).toUpperCase();
    const expiryTime = new Date(Date.now() + 30 * 60 * 1000).toLocaleString('zh-CN', {
      hour12: false,
      hour: '2-digit',
      minute: '2-digit',
      second: '2-digit'
    });
    
    alert(`学生 ${student.name} 的临时验证码: ${tempCode}\n有效期: 30分钟 (至 ${expiryTime})`);
    // 实际应用中这里会调用API生成验证码并记录到数据库
  };

  const handleAddNewStudent = () => {
    setNewStudentFormData({
      name: '',
      account: '',
      gender: '男',
      birthDate: '',
      studentNumber: '',
      evaluationLevel: '',
      campus: '',
      className: '',
      studentStatus: '潜在学生',
      followUpStatus: '待跟进',
      parentName: '',
      parentPhone: '',
      emergencyContact: '',
      emergencyPhone: '',
    });
    setShowNewStudentModal(true);
  };

  // 保存编辑
  const handleSaveEdit = () => {
    if (!editFormData.name || !editFormData.account) {
      alert('请填写姓名和登录账号');
      return;
    }
    
    // 实际应用中这里会调用API更新学生信息
    alert(`学生 ${editFormData.name} 的信息已更新`);
    setShowEditModal(false);
  };

  // 保存转班
  const handleSaveTransfer = () => {
    if (!transferFormData.targetClass) {
      alert('请选择目标班级');
      return;
    }
    
    // 实际应用中这里会调用API处理转班
    alert(`学生 ${selectedStudent?.name} 已成功从 ${transferFormData.currentClass} 转班到 ${transferFormData.targetClass}`);
    setShowTransferModal(false);
  };

  // 保存新生录入
  const handleSaveNewStudent = () => {
    if (!newStudentFormData.name || !newStudentFormData.account || !newStudentFormData.parentPhone) {
      alert('请填写必填信息（姓名、登录账号、家长电话）');
      return;
    }
    
    // 实际应用中这里会调用API创建新学生
    alert(`新生 ${newStudentFormData.name} 已成功录入`);
    setShowNewStudentModal(false);
  };

  return (
    <div className="flex-1 bg-white flex flex-col h-full overflow-hidden">
      {/* Header */}
      <div className="px-6 py-4 border-b border-gray-200">
        <h2 className="text-xl font-bold text-gray-800">学生管理</h2>
      </div>

      {/* Filter Bar */}
      <div className="p-6 pb-2 border-b border-gray-100 flex flex-wrap gap-4 items-center bg-white">
        {/* 姓名筛选 */}
        <div className="flex items-center gap-2">
          <span className="text-sm text-gray-700">姓名:</span>
          <input 
            className="border border-gray-300 rounded px-3 py-1.5 text-sm w-48 focus:outline-none focus:border-primary"
            placeholder="请输入姓名"
            value={filterName}
            onChange={e => setFilterName(e.target.value)}
          />
        </div>

        {/* 登录账号筛选 */}
        <div className="flex items-center gap-2">
          <span className="text-sm text-gray-700">登录账号:</span>
          <input 
            className="border border-gray-300 rounded px-3 py-1.5 text-sm w-48 focus:outline-none focus:border-primary"
            placeholder="请输入登录账号"
            value={filterAccount}
            onChange={e => setFilterAccount(e.target.value)}
          />
        </div>

        {/* 校区筛选 */}
        <div className="flex items-center gap-2">
          <span className="text-sm text-gray-700">校区:</span>
          <SearchableMultiSelect
            options={CAMPUSES}
            selected={filterCampus}
            onChange={setFilterCampus}
            placeholder="选择校区"
            width="w-[140px]"
            searchPlaceholder="搜索校区..."
          />
        </div>

        {/* 学生状态筛选 */}
        <div className="flex items-center gap-2">
          <span className="text-sm text-gray-700">学生状态:</span>
          <SearchableMultiSelect
            options={studentStatusOptions}
            selected={filterStudentStatus}
            onChange={setFilterStudentStatus}
            placeholder="选择状态"
            width="w-[140px]"
            searchPlaceholder="搜索状态..."
          />
        </div>

        {/* 跟进状态筛选 */}
        <div className="flex items-center gap-2">
          <span className="text-sm text-gray-700">跟进状态:</span>
          <SearchableMultiSelect
            options={followUpStatusOptions}
            selected={filterFollowUpStatus}
            onChange={setFilterFollowUpStatus}
            placeholder="选择状态"
            width="w-[140px]"
            searchPlaceholder="搜索状态..."
          />
        </div>

        {/* 操作按钮 */}
        <div className="flex items-center gap-3 ml-2">
          <button 
            className="bg-primary hover:bg-teal-600 text-white px-5 py-1.5 rounded text-sm transition-colors"
            onClick={() => {}} // 搜索逻辑已在筛选器中实时处理
          >
            搜索
          </button>
           <button 
             className="bg-primary hover:bg-teal-600 text-white px-5 py-1.5 rounded text-sm transition-colors flex-shrink-0 h-[34px] shadow-sm font-medium"
             onClick={resetFilters}
           >
             重置
           </button>

        </div>
      </div>

       {/* ACTION BAR - 新生录入和导出按钮 */}
       <div className="px-6 py-3 border-b border-gray-100 flex items-center justify-between bg-white">
          <div className="flex items-center gap-3">
             <button 
               onClick={handleAddNewStudent}
               className="bg-primary hover:bg-teal-600 text-white px-5 py-1.5 rounded text-sm transition-colors"
             >
               新生录入
             </button>
             <button 
               onClick={exportStudentList}
               className="border border-primary text-primary hover:bg-primary-light px-4 py-1.5 rounded text-sm transition-colors"
             >
               导出学生列表
             </button>
          </div>
       </div>

      {/* Table - 优化边距和操作栏固定 */}
      <div className="flex-1 overflow-hidden bg-white flex flex-col">
        <div className="flex-1 overflow-auto mx-4 my-4 border border-gray-200 rounded-lg">
          <table className="w-full text-left text-sm min-w-max">
            <thead className="bg-[#F9FBFA] text-gray-600 font-medium border-b border-gray-200 sticky top-0 z-10">
              <tr>
                <th className="p-4 whitespace-nowrap">学生ID</th>
                <th className="p-4 whitespace-nowrap">姓名</th>
                <th className="p-4 whitespace-nowrap">登录账号</th>
                <th className="p-4 whitespace-nowrap">性别</th>
                <th className="p-4 whitespace-nowrap">出生年月</th>
                <th className="p-4 whitespace-nowrap">学号</th>
                <th className="p-4 whitespace-nowrap">评测等级</th>
                <th className="p-4 whitespace-nowrap">所属校区</th>
                <th className="p-4 whitespace-nowrap">所属班级</th>
                <th className="p-4 whitespace-nowrap">学生状态</th>
                <th className="p-4 whitespace-nowrap">跟进状态</th>
                <th className="p-4 whitespace-nowrap">创建时间</th>
                <th className="p-4 whitespace-nowrap">更新时间</th>
                <th className="p-4 whitespace-nowrap sticky right-0 bg-[#F9FBFA] shadow-[-4px_0_8px_-4px_rgba(0,0,0,0.1)]">操作</th>
              </tr>
            </thead>
            <tbody className="divide-y divide-gray-100">
              {filteredStudents.map(student => (
                <tr key={student.id} className="hover:bg-gray-50 transition-colors">
                  <td className="p-4 text-gray-600 whitespace-nowrap">{student.id}</td>
                  <td className="p-4 text-gray-800 font-medium whitespace-nowrap">{student.name}</td>
                  <td className="p-4 text-gray-600 whitespace-nowrap">{student.account}</td>
                  <td className="p-4 text-gray-600 whitespace-nowrap">{student.gender}</td>
                  <td className="p-4 text-gray-600 whitespace-nowrap">{student.birthDate || '-'}</td>
                  <td className="p-4 text-gray-600 whitespace-nowrap">{student.studentNumber || '-'}</td>
                  <td className="p-4 whitespace-nowrap">
                    {student.evaluationLevel ? (
                      <span className={`px-2 py-0.5 rounded text-xs ${
                        student.evaluationLevel.includes('A+') ? 'bg-red-50 text-red-600 border border-red-200' :
                        student.evaluationLevel.includes('A') ? 'bg-orange-50 text-orange-600 border border-orange-200' :
                        student.evaluationLevel.includes('B+') ? 'bg-yellow-50 text-yellow-600 border border-yellow-200' :
                        student.evaluationLevel.includes('B') ? 'bg-green-50 text-green-600 border border-green-200' :
                        'bg-gray-50 text-gray-600 border border-gray-200'
                      }`}>
                        {student.evaluationLevel}
                      </span>
                    ) : '-'}
                  </td>
                  <td className="p-4 text-gray-600 whitespace-nowrap">{student.campus || '-'}</td>
                  <td className="p-4 whitespace-nowrap">
                    {student.className ? (
                      <span className="bg-blue-50 text-blue-500 border border-blue-200 px-2 py-0.5 rounded text-xs">
                        {student.className}
                      </span>
                    ) : '-'}
                  </td>
                  <td className="p-4 whitespace-nowrap">
                    {student.studentStatus ? (
                      <span className={`px-2 py-0.5 rounded text-xs ${
                        student.studentStatus === '在读学生' ? 'bg-green-50 text-green-600 border border-green-200' :
                        student.studentStatus === '潜在学生' ? 'bg-blue-50 text-blue-600 border border-blue-200' :
                        'bg-gray-50 text-gray-600 border border-gray-200'
                      }`}>
                        {student.studentStatus}
                      </span>
                    ) : '-'}
                  </td>
                  <td className="p-4 whitespace-nowrap">
                    {student.followUpStatus ? (
                      <span className={`px-2 py-0.5 rounded text-xs ${
                        student.followUpStatus === '已签约' ? 'bg-green-50 text-green-600 border border-green-200' :
                        student.followUpStatus === '已邀约' ? 'bg-blue-50 text-blue-600 border border-blue-200' :
                        student.followUpStatus === '跟进中' ? 'bg-yellow-50 text-yellow-600 border border-yellow-200' :
                        student.followUpStatus === '待跟进' ? 'bg-orange-50 text-orange-600 border border-orange-200' :
                        'bg-red-50 text-red-600 border border-red-200'
                      }`}>
                        {student.followUpStatus}
                      </span>
                    ) : '-'}
                  </td>
                  <td className="p-4 text-gray-600 text-xs whitespace-nowrap">{student.createdTime}</td>
                  <td className="p-4 text-gray-600 text-xs whitespace-nowrap">{student.updatedTime}</td>
                  <td className="p-4 sticky right-0 bg-white shadow-[-4px_0_8px_-4px_rgba(0,0,0,0.1)]">
                    <div className="flex flex-col gap-1.5 text-xs whitespace-nowrap">
                      <div className="flex gap-3">
                        <span 
                          className="text-primary cursor-pointer hover:opacity-80"
                          onClick={() => handleEdit(student)}
                        >
                          编辑
                        </span>
                        <span 
                          className="text-blue-500 cursor-pointer hover:opacity-80"
                          onClick={() => handleTransferClass(student)}
                        >
                          转班
                        </span>
                        <span 
                          className="text-purple-600 cursor-pointer hover:opacity-80"
                          onClick={() => handleViewOperationLog(student)}
                        >
                          操作记录
                        </span>
                      </div>
                      <div 
                        className="text-orange-400 cursor-pointer hover:opacity-80"
                        onClick={() => handleGetTempCode(student)}
                      >
                        获取临时验证码
                      </div>
                    </div>
                  </td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>
      </div>

      {/* Pagination Footer */}
      <div className="px-6 py-4 border-t border-gray-100 flex items-center justify-end text-sm text-gray-600 bg-white gap-2">
        <span>总计 {filteredStudents.length} 条</span>
        <button className="px-2 hover:text-primary">&lt;</button>
        <button className="w-7 h-7 flex items-center justify-center rounded hover:bg-gray-100">1</button>
        <button className="w-7 h-7 flex items-center justify-center rounded bg-primary text-white border border-primary">2</button>
        <button className="w-7 h-7 flex items-center justify-center rounded hover:bg-gray-100">3</button>
        <button className="w-7 h-7 flex items-center justify-center rounded hover:bg-gray-100">4</button>
        <button className="w-7 h-7 flex items-center justify-center rounded hover:bg-gray-100">5</button>
        <span>...</span>
        <button className="w-7 h-7 flex items-center justify-center rounded hover:bg-gray-100">251</button>
        <button className="px-2 hover:text-primary">&gt;</button>
        <select className="border border-gray-300 rounded px-2 py-1 ml-2 text-xs">
          <option>20 条/页</option>
          <option>50 条/页</option>
        </select>
       </div>

       {/* 编辑学生模态框 */}
       {showEditModal && (
         <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/50 p-4">
           <div className="bg-white rounded-xl shadow-xl w-[600px] flex flex-col overflow-hidden">
             <div className="px-6 py-4 border-b border-gray-100 flex justify-between items-center bg-gray-50">
               <h3 className="text-lg font-bold text-gray-800">编辑学生信息</h3>
               <button onClick={() => setShowEditModal(false)} className="text-gray-400 hover:text-gray-600 text-2xl leading-none">&times;</button>
             </div>
             
             <div className="p-6 space-y-4">
               <div className="flex items-center">
                 <label className="w-24 text-sm font-medium text-gray-600 text-right mr-4"><span className="text-red-500 mr-1">*</span>姓名</label>
                 <input 
                   className="flex-1 border border-gray-300 rounded px-3 py-2 text-sm focus:outline-none focus:border-primary"
                   value={editFormData.name}
                   onChange={e => setEditFormData({...editFormData, name: e.target.value})}
                   placeholder="请输入学生姓名"
                 />
               </div>

               <div className="flex items-center">
                 <label className="w-24 text-sm font-medium text-gray-600 text-right mr-4"><span className="text-red-500 mr-1">*</span>登录账号</label>
                 <input 
                   className="flex-1 border border-gray-300 rounded px-3 py-2 text-sm focus:outline-none focus:border-primary"
                   value={editFormData.account}
                   onChange={e => setEditFormData({...editFormData, account: e.target.value})}
                   placeholder="请输入登录账号"
                 />
               </div>

               <div className="flex items-center">
                 <label className="w-24 text-sm font-medium text-gray-600 text-right mr-4">性别</label>
                 <div className="flex gap-6 text-sm">
                   <label className="flex items-center gap-2 cursor-pointer">
                     <input 
                       type="radio" 
                       name="gender" 
                       checked={editFormData.gender === '男'} 
                       onChange={() => setEditFormData({...editFormData, gender: '男'})}
                       className="text-primary"
                     /> 男
                   </label>
                   <label className="flex items-center gap-2 cursor-pointer">
                     <input 
                       type="radio" 
                       name="gender" 
                       checked={editFormData.gender === '女'} 
                       onChange={() => setEditFormData({...editFormData, gender: '女'})}
                       className="text-primary"
                     /> 女
                   </label>
                 </div>
               </div>

               <div className="flex items-center">
                 <label className="w-24 text-sm font-medium text-gray-600 text-right mr-4">出生年月</label>
                 <input 
                   type="date"
                   className="flex-1 border border-gray-300 rounded px-3 py-2 text-sm focus:outline-none focus:border-primary"
                   value={editFormData.birthDate}
                   onChange={e => setEditFormData({...editFormData, birthDate: e.target.value})}
                 />
               </div>

               <div className="flex items-center">
                 <label className="w-24 text-sm font-medium text-gray-600 text-right mr-4">学号</label>
                 <input 
                   className="flex-1 border border-gray-300 rounded px-3 py-2 text-sm focus:outline-none focus:border-primary"
                   value={editFormData.studentNumber}
                   onChange={e => setEditFormData({...editFormData, studentNumber: e.target.value})}
                   placeholder="请输入学号"
                 />
               </div>

               <div className="flex items-center">
                 <label className="w-24 text-sm font-medium text-gray-600 text-right mr-4">评测等级</label>
                 <select 
                   className="flex-1 border border-gray-300 rounded px-3 py-2 text-sm focus:outline-none focus:border-primary bg-white"
                   value={editFormData.evaluationLevel}
                   onChange={e => setEditFormData({...editFormData, evaluationLevel: e.target.value})}
                 >
                   <option value="">请选择评测等级</option>
                   <option value="A+">A+</option>
                   <option value="A">A</option>
                   <option value="A-">A-</option>
                   <option value="B+">B+</option>
                   <option value="B">B</option>
                   <option value="B-">B-</option>
                   <option value="C+">C+</option>
                   <option value="C">C</option>
                 </select>
               </div>

               <div className="flex items-center">
                 <label className="w-24 text-sm font-medium text-gray-600 text-right mr-4">所属校区</label>
                 <select 
                   className="flex-1 border border-gray-300 rounded px-3 py-2 text-sm focus:outline-none focus:border-primary bg-white"
                   value={editFormData.campus}
                   onChange={e => setEditFormData({...editFormData, campus: e.target.value})}
                 >
                   <option value="">请选择校区</option>
                   {CAMPUSES.map(campus => <option key={campus} value={campus}>{campus}</option>)}
                 </select>
               </div>

               <div className="flex items-center">
                 <label className="w-24 text-sm font-medium text-gray-600 text-right mr-4">所属班级</label>
                 <input 
                   className="flex-1 border border-gray-300 rounded px-3 py-2 text-sm focus:outline-none focus:border-primary"
                   value={editFormData.className}
                   onChange={e => setEditFormData({...editFormData, className: e.target.value})}
                   placeholder="请输入班级名称"
                 />
               </div>

               <div className="flex items-center">
                 <label className="w-24 text-sm font-medium text-gray-600 text-right mr-4">学生状态</label>
                 <select 
                   className="flex-1 border border-gray-300 rounded px-3 py-2 text-sm focus:outline-none focus:border-primary bg-white"
                   value={editFormData.studentStatus}
                   onChange={e => setEditFormData({...editFormData, studentStatus: e.target.value as StudentStatus})}
                 >
                   {studentStatusOptions.map(status => <option key={status} value={status}>{status}</option>)}
                 </select>
               </div>

               <div className="flex items-center">
                 <label className="w-24 text-sm font-medium text-gray-600 text-right mr-4">跟进状态</label>
                 <select 
                   className="flex-1 border border-gray-300 rounded px-3 py-2 text-sm focus:outline-none focus:border-primary bg-white"
                   value={editFormData.followUpStatus}
                   onChange={e => setEditFormData({...editFormData, followUpStatus: e.target.value as FollowUpStatus})}
                 >
                   {followUpStatusOptions.map(status => <option key={status} value={status}>{status}</option>)}
                 </select>
               </div>
             </div>

             <div className="p-6 border-t border-gray-100 flex justify-end gap-3 bg-gray-50">
               <button 
                 onClick={() => setShowEditModal(false)}
                 className="px-6 py-2 border border-gray-300 rounded text-gray-600 bg-white hover:bg-gray-50 text-sm"
               >
                 取消
               </button>
               <button 
                 onClick={handleSaveEdit}
                 className="px-6 py-2 bg-primary text-white rounded shadow-sm hover:bg-teal-600 text-sm"
               >
                 保存
                </button>
              </div>
            </div>
          </div>
        </div>
      )}

       {/* 转班模态框 */}
       {showTransferModal && (
         <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/50 p-4">
           <div className="bg-white rounded-xl shadow-xl w-[500px] flex flex-col overflow-hidden">
             <div className="px-6 py-4 border-b border-gray-100 flex justify-between items-center bg-gray-50">
               <h3 className="text-lg font-bold text-gray-800">学生转班</h3>
               <button onClick={() => setShowTransferModal(false)} className="text-gray-400 hover:text-gray-600 text-2xl leading-none">&times;</button>
             </div>
             
             <div className="p-6 space-y-4">
               <div className="flex items-center">
                 <label className="w-32 text-sm font-medium text-gray-600 text-right mr-4">学生姓名</label>
                 <span className="text-gray-800 font-medium">{selectedStudent?.name}</span>
               </div>

               <div className="flex items-center">
                 <label className="w-32 text-sm font-medium text-gray-600 text-right mr-4">当前班级</label>
                 <span className="text-gray-600">{transferFormData.currentClass || '未分配班级'}</span>
               </div>

               <div className="flex items-center">
                 <label className="w-32 text-sm font-medium text-gray-600 text-right mr-4"><span className="text-red-500 mr-1">*</span>目标班级</label>
                 <input 
                   className="flex-1 border border-gray-300 rounded px-3 py-2 text-sm focus:outline-none focus:border-primary"
                   value={transferFormData.targetClass}
                   onChange={e => setTransferFormData({...transferFormData, targetClass: e.target.value})}
                   placeholder="请输入目标班级名称"
                 />
               </div>

               <div className="flex items-center">
                 <label className="w-32 text-sm font-medium text-gray-600 text-right mr-4">转班日期</label>
                 <input 
                   type="date"
                   className="flex-1 border border-gray-300 rounded px-3 py-2 text-sm focus:outline-none focus:border-primary"
                   value={transferFormData.transferDate}
                   onChange={e => setTransferFormData({...transferFormData, transferDate: e.target.value})}
                 />
               </div>

               <div className="flex items-center">
                 <label className="w-32 text-sm font-medium text-gray-600 text-right mr-4">转班原因</label>
                 <textarea 
                   className="flex-1 border border-gray-300 rounded px-3 py-2 text-sm focus:outline-none focus:border-primary resize-none h-20"
                   value={transferFormData.reason}
                   onChange={e => setTransferFormData({...transferFormData, reason: e.target.value})}
                   placeholder="请输入转班原因"
                 />
               </div>
             </div>

             <div className="p-6 border-t border-gray-100 flex justify-end gap-3 bg-gray-50">
               <button 
                 onClick={() => setShowTransferModal(false)}
                 className="px-6 py-2 border border-gray-300 rounded text-gray-600 bg-white hover:bg-gray-50 text-sm"
               >
                 取消
               </button>
               <button 
                 onClick={handleSaveTransfer}
                 className="px-6 py-2 bg-primary text-white rounded shadow-sm hover:bg-teal-600 text-sm"
               >
                 确认转班
               </button>
             </div>
           </div>
         </div>
       )}
     </div>
   );
 };

export default StudentManagement;